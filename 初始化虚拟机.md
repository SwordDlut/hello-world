# 虚拟机标准处理过程

### 初始化虚拟机步骤

#### 1.查看并挂载磁盘
用
<br />`df -h`
<br />`sudo fdisk -l`
<br />`free -h`
<br />`cat /proc/cpuinfo`
<br />检查磁盘大小、内存大小、cpu核数和频率
<br />*Tips:
<br />如果sudo fdisk -l显示出的磁盘，在 df -h命令下没有。
<br />那么该磁盘未挂载。*
<br /><br />如果磁盘未挂载且确定磁盘内容为空需要格式化
<br />`echo y | sudo mkfs.ext4 /dev/vdb`
<br /><br />格式化后需要挂载数据盘
<br />`sudo mount /dev/vdb /opt`
<br />*Tips：
<br />挂载后出现
<br />`{Disk identifier: 0x00000000`
<br />`Disk /dev/vdb doesn't contain a valid partition table}`
<br />无碍。*

#### 2. 更改配置host等
`sudo vi /etc/hostname`
<br />`sudo vi /etc/hosts`
<br />*Tips：
<br />将hostname和ip等加入文件中*
<br /><br />在编辑fstab前执行
<br />`sudo mount /dev/vdb /opt`
<br />再次确认磁盘已经格式化
<br /><br />`sudo vi /etc/fstab`
<br />`/dev/vdb         /opt            ext4    errors=remount-ro,noatime 1 2`
<br /><br />修改apt source，去除社区维护的source和实验性source
<br />`sudo vi /etc/apt/sources.list`
<br />`deb http://apt.ksyun.cn/ubuntu/ trusty main restricted universe`
<br />`deb http://apt.ksyun.cn/ubuntu/ trusty-backports main restricted`
<br />`deb http://apt.ksyun.cn/ubuntu/ trusty-security main restricted universe multiverse`
<br />`deb http://apt.ksyun.cn/ubuntu/ trusty-updates main restricted`

#### 3. 查看系统版本信息
`cat /etc/issue`
<br />`sudo lsb_release -a`
<br />`uname -r`

#### 4. 初始化为 14.04 的系统
`sudo vi /etc/init.d/elfin`
<br />`### BEGIN INIT INFO`
<br />`# Provides:          elfin`
<br />`# Required-Start:    $local_fs $network`
<br />`# Required-Stop:     $local_fs`
<br />`# Default-Start:     2 3 4 5`
<br />`# Default-Stop:      0 1 6`
<br />`# Short-Description: elfin`
<br />`# Description:       elfin`
<br />`### END INIT INFO`
<br /><br />`sudo vi /etc/init.d/agentboot`
<br />`### BEGIN INIT INFO`
<br />`# Provides:          agentboot`
<br />`# Required-Start:    $local_fs $network`
<br />`# Required-Stop:     $local_fs`
<br />`# Default-Start:     2 3 4 5`
<br />`# Default-Stop:      0 1 6`
<br />`# Short-Description: agentboot`
<br />`# Description:       agentboot`
<br />`### END INIT INFO`

#### 5. 系统升级
`sudo aptitude update`
<br />`sudo aptitude -y install apt dpkg`
<br />`do-release-upgrade`
<br /><br />升级中
<br />rsyslog的提示选择y
<br />`Configuring unattended-upgrades 的提示选择 install the package maintainer's version`
<br />其余选缺省值即可
<br /><br />重启后
<br />`sudo rm /etc/apt/apt.conf.d/50unattended-upgrades.ucf-old`
<br /><br />用
<br />`cat /etc/issue`
<br />`sudo lsb_release -a`
<br />`uname -r`
<br />查看系统版本及linux内核版本。

#### 6. 安装docker
`sudo mkdir -p /opt/var/lib/docker`
<br />`sudo chmod 711 /opt/var/lib/docker`
<br />`sudo ln -s /opt/var/lib/docker /var/lib/docker`
<br />`curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -`
<br /><br />`>>> 生产环境下的虚拟机`
<br />`sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"`
<br />`<<< 生产环境下的虚拟机`
<br /><br />`>>> 开发环境下的虚拟机`
<br />`sudo add-apt-repository "deb [arch=amd64] http://docker.apt.cacher.ng $(lsb_release -cs) stable"`
<br />`echo 'Acquire::http::Proxy::docker.apt.cacher.ng "http://infra-apt.dev.migame.g.mi.com:3142";' | sudo tee /etc/apt/apt.conf.d/00aptproxy`
<br />`<<< 开发环境下的虚拟机`
<br /><br />`sudo apt update`
<br />`sudo apt -y install docker-ce`
<br />`sudo apt -y upgrade`
<br />`sudo apt -y autoremove`

#### 7. 设置镜像服务器
`>>> 开发环境下的虚拟机`
<br />`sudo usermod -aG docker ubuntu`
<br />`echo '{ "registry-mirrors": ["http://10.38.162.23:5000"] }' | sudo tee /etc/docker/daemon.json`
<br />`sudo systemctl restart docker.service`
<br />`<<< 开发环境下的虚拟机`
<br /><br />`>>> 生产环境下的虚拟机`
<br />`echo '{ "registry-mirrors": [ "http://10.38.11.181:5000", "http://10.38.11.195:5000", "http://10.38.11.160:5000" ] }' | sudo tee /etc/docker/daemon.json`
<br />`sudo systemctl restart docker.service`
<br />`<<< 生产环境下的虚拟机`

#### 8. 重启
`sudo reboot`
