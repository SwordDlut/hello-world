#虚拟机标准处理过程

申请虚拟机地址 http://xbudget.pt.xiaomi.com
申请重置为 Ubuntu 地址 http://jira.n.xiaomi.com/browse/SASYS-5433?jql=project%20%3D%20SASYS
创建问题单，模块选 公有云-金山云
有 Ubuntu 14.04 和 Ubuntu 16.04 两种可选，貌似16.04可以用relay

###初始化虚拟机步骤
####1. 查看并挂载磁盘
>`df -h`
>`sudo fdisk -l`
>`free -h`
>`cat /proc/cpuinfo`
>检查磁盘大小、内存大小、cpu核数和频率
>Tips:
>sudo fdisk -l显示出的磁盘，在 df -h命令下没有。
>那么该磁盘未挂载。
>
>---如果磁盘未挂载且确定磁盘内容为空需要格式化
>---`echo y | sudo mkfs.ext4 /dev/vdb`
>
>---格式化后需要挂载数据盘
>---`sudo mount /dev/vdb /opt`
>
>Tips：
>挂载后出现
>`{Disk identifier: 0x00000000`
>`Disk /dev/vdb doesn't contain a valid partition table}`
>无碍。

####2. 更改配置host等
>`sudo vi /etc/hostname`
>`sudo vi /etc/hosts`
>Tips：
将hostname和ip等加入文件中

>`sudo vi /etc/fstab`
>`/dev/vdb         /opt            ext4    errors=remount-ro,noatime 1 2`

>修改apt source，去除社区维护的source和实验性source
`sudo vi /etc/apt/sources.list`
`deb http://apt.ksyun.cn/ubuntu/ trusty main restricted universe`
`deb http://apt.ksyun.cn/ubuntu/ trusty-backports main restricted`
`deb http://apt.ksyun.cn/ubuntu/ trusty-security main restricted universe multiverse`
`deb http://apt.ksyun.cn/ubuntu/ trusty-updates main restricted`

####3. 查看系统版本信息
>`cat /etc/issue`
>`sudo lsb_release -a`
>`uname -r`

####4. 初始化为 14.04 的系统
>`sudo vi /etc/init.d/elfin`
>`### BEGIN INIT INFO`
>`# Provides:          elfin`
>`# Required-Start:    $local_fs $network`
>`# Required-Stop:     $local_fs`
>`# Default-Start:     2 3 4 5`
>`# Default-Stop:      0 1 6`
>`# Short-Description: elfin`
>`# Description:       elfin`
>`### END INIT INFO`
>
>`sudo vi /etc/init.d/agentboot`
>`### BEGIN INIT INFO`
>`# Provides:          agentboot`
>`# Required-Start:    $local_fs $network`
>`# Required-Stop:     $local_fs`
>`# Default-Start:     2 3 4 5`
>`# Default-Stop:      0 1 6`
>`# Short-Description: agentboot`
>`# Description:       agentboot`
>`### END INIT INFO`
>
####5. 系统升级
>`sudo aptitude update`
>`sudo aptitude -y install apt dpkg`
>`do-release-upgrade`
>
>升级中
>rsyslog的提示选择y
>`Configuring unattended-upgrades 的提示选择 install the package maintainer's version`
>其余选缺省值即可
>
>重启后
>`sudo rm /etc/apt/apt.conf.d/50unattended-upgrades.ucf-old`

>用
>`cat /etc/issue`
>`sudo lsb_release -a`
>`uname -r`
>查看系统版本及linux内核版本。

####6. 安装docker
>`sudo mkdir -p /opt/var/lib/docker`
>`sudo chmod 711 /opt/var/lib/docker`
>`sudo ln -s /opt/var/lib/docker /var/lib/docker`
>`curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -`
>`sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"`
>`sudo apt update`
>`sudo apt -y install docker-ce`
>`sudo apt -y upgrade`
>`sudo apt -y autoremove`

####7. 设置镜像服务器
>开发环境下的虚拟机
>`sudo usermod -aG docker ubuntu`
>`echo '{ "registry-mirrors": ["http://10.38.162.23:5000"] }' | sudo tee /etc/docker/daemon.json`
>`sudo systemctl restart docker.service`

> 生产环境下的虚拟机
>`echo '{ "registry-mirrors": [ "http://10.38.11.181:5000", "http://10.38.11.195:5000", "http://10.38.11.160:5000" ] }' | sudo tee /etc/docker/daemon.json`
>`sudo systemctl restart docker.service`


####8. 重启
>`sudo reboot`
